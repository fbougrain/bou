rules_version = '2';
service cloud.firestore {
	match /databases/{database}/documents {
		function signedIn() {
			return request.auth != null;
		}

		// The owner is the user who created the project. We store their UID in ownerUid.
		function isOwner() {
			return signedIn() && resource.data.ownerUid == request.auth.uid;
		}

		// A member is any user listed in the members array.
		function isMember() {
			return signedIn() && request.auth.uid in resource.data.members;
		}

		// Helpers to check membership/ownership against the parent project doc
		function projectDoc(projectId) {
			return get(/databases/$(database)/documents/projects/$(projectId));
		}
		function isProjectOwner(projectId) {
			return signedIn() && projectDoc(projectId).data.ownerUid == request.auth.uid;
		}
		function isProjectMember(projectId) {
			return signedIn() && request.auth.uid in projectDoc(projectId).data.members;
		}

		// Detect a tightly-scoped "join" update where a non-member adds themselves
		// to the project's members array without changing the owner or other fields.
		function isJoinAttempt() {
			return signedIn()
				&& resource.data.ownerUid == request.resource.data.ownerUid
				&& request.auth.uid in request.resource.data.members
				&& request.resource.data.members is list
				&& (
					// Case A: no existing members -> new members array must be exactly the requester
					(resource.data.members.size() == 0 && request.resource.data.members.size() == 1)
					// Case B: there are existing members -> new members must include all existing members
					// and be exactly one element larger (the requester)
					|| (request.resource.data.members.hasAll(resource.data.members)
						&& request.resource.data.members.size() == resource.data.members.size() + 1)
				);
		}

		match /projects/{projectId} {
			// Anyone signed-in may create a project; the client sets ownerUid and adds themselves to members.
			allow create: if signedIn();

			// Read is allowed to members and owner (covers legacy where ownerUid exists but not in members).
			allow read: if isMember() || isOwner();

			// Updates are allowed to members or owner. Additionally, allow a tightly-scoped
			// non-member update that represents "joining": the requester may add themself
			// to the members array while preserving ownerUid and existing members.
			allow update: if isMember() || isOwner() || isJoinAttempt();

			// Delete is allowed only when the requester is the last user on the project (owner or member)
			// i.e., members array size is 1 and contains the requester.
			allow delete: if signedIn() && resource.data.members.size() == 1 &&
										request.auth.uid in resource.data.members;

			// Subcollections under a project (scoped per project):
			//   team            ("Team")
			//   tasks           ("Tasks")
			//   stock           ("Stocks")
			//   forms           ("Forms")
			//   expenses        ("Billing")
			//   media           ("Media")
			//   notifications   ("Notifications")
			//   chats/<chatId>/messages ("Chats")
			// These are all currently governed by the same read/write rule below.
			// Note: Reports are now a top-level collection (see below)
			match /{sub=**} {
				// Allow members/owner to read and write their project's subcollections
				allow read: if isProjectMember(projectId) || isProjectOwner(projectId);
				allow write: if isProjectMember(projectId) || isProjectOwner(projectId);
			}
		}

		// Users manage their own profile document
		match /users/{uid} {
			allow read, write: if signedIn() && uid == request.auth.uid;
		}

		// Reports collection (top-level)
		match /reports/{reportId} {
			// Anyone signed in can create a report
			allow create: if signedIn();
			// Only project members/owners can read reports for their projects
			allow read: if signedIn() && (
				isProjectMember(resource.data.projectId) || 
				isProjectOwner(resource.data.projectId)
			);
			// Only project owners can update/delete reports (for moderation)
			allow update, delete: if signedIn() && isProjectOwner(resource.data.projectId);
		}

		// Deny everything else by default
		match /{document=**} {
			allow read, write: if false;
		}
	}
}
